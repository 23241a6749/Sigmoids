# Architecture

> Auto-generated by /map on 2026-02-27

## Overview

KiranaLink is a full-stack platform designed for local shop owners (Kirana stores). It features a central dashboard (React frontend) to manage billing, customer ledgers, supplier bills, inventory management, group buying capabilities, and powerful integrations with AI and telecommunication services (WhatsApp, voice agents) to act as a virtual assistant for the store owner.

```text
┌─────────────────────────────────────────┐
│              Frontend (React)           │
│  (UI Components, Features, Dexie, VAPI) │
├─────────────────────────────────────────┤
│         WebSocket / REST API Layer      │
├─────────────────────────────────────────┤
│         Backend (Express Server)        │
│ (Twilio WA, AI integrations, Routes)    │
├─────────────────────────────────────────┤
│            Data Layer (MongoDB)         │
│          (Mongoose Models/Schemas)      │
└─────────────────────────────────────────┘
```

## Components

### Frontend (`/src`)
- **Purpose:** React-based user interface using Vite. It offers various specialized dashboards (Analytics, Billing, Recoveries, Authentication).
- **Location:** `d:\Vivitsu\kiranaLink\src`
- **Dependencies:** React, React Router Dom, Tailwindcss, Framer Motion, Recharts, Dexie (IndexedDB), Canvas Confetti, @vapi-ai/web, Tesseract.js, Socket.io-client.

### Backend Application (`/server/src`)
- **Purpose:** Node.js/Express REST server acting as the central intelligence node. Handles database connections, AI processing, Twilio webhook integration, and WebSocket communications.
- **Location:** `d:\Vivitsu\kiranaLink\server\src`
- **Dependencies:** Express, Mongoose, Socket.io, Twilio, OpenAI, @google/generative-ai, Ollama, bcryptjs, jsonwebtoken.

### Data Models (`/server/src/models`)
- **Purpose:** Mongoose schemas defining the data structure for Users, SupplierBills, Products, GlobalProducts, OTPs, LedgerEntries, GroupBuys, CustomerAccounts, Customers, and Bills.

### AI Integration Services (`/server/src/routes/ai.ts` & Various Utils)
- **Purpose:** Integrates directly with multiple AI backends (OpenAI, Gemini, Ollama running locally) to provide intelligent features like receipt processing, voice processing, and text analysis from WhatsApp messages.

### Communication Webhooks (`/server/src/routes/whatsapp.ts`)
- **Purpose:** Connects to Twilio for handling incoming WhatsApp messages, parsing them, and providing AI-augmented smart replies directly within the chat.

## Data Flow

1. **User Action / Event:** Store owner interacts with the React frontend (e.g., adding a bill, requesting an AI voice call to a customer via VAPI).
2. **REST API / Socket Emit:** The frontend dispatches an HTTP request via Axios to the Express backend, or emits a real-time event via Socket.IO.
3. **Backend Processing:** 
   - HTTP routes validate requests and interact with MongoDB using Mongoose.
   - For Twilio/WhatsApp interactions, the webhook endpoint receives payloads, handles them with AI utils, and emits real-time updates back to the frontend's LiveFeed.
4. **Data Persistence:** Records (bills, ledgers, inventory) are saved into MongoDB.
5. **Real-time Feedback:** Server pushes updates back to connected clients via Socket.IO to immediately reflect new stats, ledger events, or WhatsApp messages.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| VAPI | Web API | AI Voice agents for automated customer recovery and interaction calls. |
| Twilio | Webhook/API | WhatsApp messaging features and SMS fallbacks. |
| OpenAI / Gemini | API | Powerful Large Language Models for unstructured data processing and chat responses. |
| Ollama | Local API | Local or self-hosted AI model integration for cost-saving/privacy. |
| Socket.IO | WebSockets | Real-time bi-directional event stream between Express and React clients. |

## Technical Debt

- [ ] Hardcoded JWT tokens / secrets specifically bypassed/added for hackathons (`JWT_SECRET` fallbacks).
- [ ] Mock databases and "insane hacks" explicitly noted in the server routing codebase (e.g., `whatsapp.ts` line 10 mock DB).
- [ ] Implementations utilizing simulated inputs (Hackathon simulation placeholders for API calls like audio parsing).
- [ ] Potential lack of thorough error constraints in hacky mock features (reliance on 'optimistic' operations expecting users enter valid keys rather than handling fails smoothly - `firebase.ts` line 28).

## Conventions

**Naming:** PascalCase for React components and Mongoose Models. camelCase for variables, services, and route definitions.
**Structure:** Frontend uses a feature-based structure (`/src/features`) with separate components, hooks, services. Backend uses standard MVC-inspired layers (`/routes`, `/models`, `/utils`, `/middleware`).
**Real-Time approach:** WebSockets are central to user experience, pushing database alterations up to the client immediately.
